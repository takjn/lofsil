# LOFSIL
WIP

GR-PEACHで動作するサンプルプログラムです。  

## ビルド手順
開発環境の構築は、[GR-LYCHEE用オフライン開発環境の手順](https://developer.mbed.org/users/dkato/notebook/offline-development-lychee-langja/)を参照ください。

### GR-PEACHの場合
$ mbed compile -m RZ_A1H -t GCC_ARM --profile debug

## 概要
USB0にUSBケーブルを接続してPC用アプリ [DisplayApp](https://developer.mbed.org/users/dkato/code/DisplayApp/)でカメラ映像が表示できます。

～参考ページ～  
[がじぇっとるねさすコミュニティ GR-LYCHEE OpenCV](http://japan.renesasrulz.com/gr_user_forum_japanese/f/gr-lychee/4208/gr-lychee-opencv)

## 実行方法
```
cd client && ruby -rwebrick -e 'WEBrick::HTTPServer.new(:DocumentRoot => "./", :Port => 8000).start'
```

## node-red
データを受信して位置情報、点群データ、3Dヒートマップに変換するためのnode-redフロー

```
[{"id":"a993b985.46eba8","type":"websocket out","z":"9eb2d149.5177b","name":"","server":"959d4d6.767d6b","client":"","x":745.8888549804688,"y":238.44442749023438,"wires":[]},{"id":"a42d3354.bf81e","type":"inject","z":"9eb2d149.5177b","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":true,"x":112.44444274902344,"y":79.22222137451172,"wires":[["b99ed823.966318"]]},{"id":"b99ed823.966318","type":"function","z":"9eb2d149.5177b","name":"初期化","func":"global.set(\"pointcloud\", {});\nglobal.set(\"_pointcloud\", {});\n\nglobal.set(\"heatmap\", {});\nglobal.set(\"heatmap_tmp\", []);\nglobal.set(\"heatmap_idx\", 0);\n\nglobal.set(\"_position\", {x:0, y:0, z:0});\nglobal.set(\"count\", 0);\n\nreturn msg;","outputs":1,"noerr":0,"x":286.4444580078125,"y":79,"wires":[["7d6df4ac.891b6c"]]},{"id":"7d6df4ac.891b6c","type":"debug","z":"9eb2d149.5177b","name":"","active":true,"console":"false","complete":"false","x":482,"y":79,"wires":[]},{"id":"402f02b8.066e8c","type":"function","z":"9eb2d149.5177b","name":"位置情報の送信","func":"delete msg._session;\nreturn msg;","outputs":1,"noerr":0,"x":520,"y":238,"wires":[["92590b03.e1a5d8","a993b985.46eba8"]]},{"id":"92590b03.e1a5d8","type":"debug","z":"9eb2d149.5177b","name":"","active":false,"console":"false","complete":"payload","x":736,"y":187,"wires":[]},{"id":"5cb851b.8c357b","type":"websocket in","z":"9eb2d149.5177b","name":"","server":"4347228e.e8e62c","client":"","x":131,"y":242,"wires":[["46442ed2.988f"]]},{"id":"46442ed2.988f","type":"switch","z":"9eb2d149.5177b","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"end","vt":"str"},{"t":"else"}],"checkall":"true","outputs":2,"x":241,"y":334,"wires":[["2693329c.7d37ae","26a4ab25.3f2d84"],["c61fba57.e87be8","fd11ff0c.d820f"]]},{"id":"c61fba57.e87be8","type":"function","z":"9eb2d149.5177b","name":"点群データの更新","func":"// 点群データ\nvar data = global.get(\"_pointcloud\");\n\nif (msg.payload in data) {\n    data[msg.payload] += 1;\n} else {\n    data[msg.payload] = 1;\n}\n\nglobal.set(\"_pointcloud\", data);\n\nreturn msg;","outputs":1,"noerr":0,"x":440,"y":456,"wires":[[]]},{"id":"2693329c.7d37ae","type":"function","z":"9eb2d149.5177b","name":"点群データの確定","func":"var pointcloud = global.get(\"_pointcloud\");\nglobal.set(\"pointcloud\", pointcloud);\nglobal.set(\"_pointcloud\", {});\n\nreturn msg;","outputs":1,"noerr":0,"x":456,"y":327,"wires":[["fb39a1ae.d2114"]]},{"id":"fa44c0bc.d0c18","type":"debug","z":"9eb2d149.5177b","name":"","active":false,"console":"false","complete":"payload","x":723,"y":393,"wires":[]},{"id":"9e8aa9bd.3210b8","type":"http in","z":"9eb2d149.5177b","name":"","url":"/pointcloud","method":"get","swaggerDoc":"","x":132,"y":529,"wires":[["27aa573b.143278"]]},{"id":"93f7263c.7b8488","type":"http response","z":"9eb2d149.5177b","name":"","x":560,"y":564,"wires":[]},{"id":"27aa573b.143278","type":"function","z":"9eb2d149.5177b","name":"点群データの取得","func":"msg.payload = global.get(\"pointcloud\");\nmsg.headers = {\"Access-Control-Allow-Origin\": \"*\"};\n\nreturn msg;\n","outputs":1,"noerr":0,"x":351,"y":539,"wires":[["93f7263c.7b8488"]]},{"id":"fd11ff0c.d820f","type":"function","z":"9eb2d149.5177b","name":"位置情報の更新","func":"var count = global.get(\"count\");\ncount++;\nglobal.set(\"count\", count);\n\nvar position = global.get(\"_position\");\nvar data = msg.payload.split(\" \");\n\nposition.x += parseInt(data[0]);\nposition.y += parseInt(data[1]);\nposition.z += parseInt(data[2]);\n\nglobal.set(\"_position\", position);\n\nreturn msg;","outputs":1,"noerr":0,"x":432,"y":413,"wires":[[]]},{"id":"26a4ab25.3f2d84","type":"function","z":"9eb2d149.5177b","name":"位置情報の確定","func":"var count = global.get(\"count\");\nif (count === 0) return null;\n\nvar position = global.get(\"_position\");\nposition.x = Math.round(position.x / count);\nposition.y = Math.round(position.y / count);\nposition.z = Math.round(position.z / count);\n\nmsg.payload = position;\n\nglobal.set(\"_position\", {x:0, y:0, z:0});\nglobal.set(\"count\", 0);\n\nreturn msg;","outputs":1,"noerr":0,"x":446,"y":174,"wires":[["402f02b8.066e8c"]]},{"id":"820e64f0.f1dab8","type":"http in","z":"9eb2d149.5177b","name":"","url":"/heatmap","method":"get","swaggerDoc":"","x":122,"y":607,"wires":[["b61a10d8.d3e4a"]]},{"id":"b5cf7415.1aa208","type":"http response","z":"9eb2d149.5177b","name":"","x":553,"y":653,"wires":[]},{"id":"b61a10d8.d3e4a","type":"function","z":"9eb2d149.5177b","name":"ヒートマップの取得","func":"msg.payload = global.get(\"heatmap\");\nmsg.headers = {\"Access-Control-Allow-Origin\": \"*\"};\n\nreturn msg;","outputs":1,"noerr":0,"x":347,"y":627,"wires":[["b5cf7415.1aa208"]]},{"id":"fb39a1ae.d2114","type":"function","z":"9eb2d149.5177b","name":"ヒートマップの確定","func":"var idx = global.get(\"heatmap_idx\");\nif (idx == 10) {\n    idx = 0;\n}\nelse {\n    idx++;\n}\n\nvar heatmap_tmp = global.get(\"heatmap_tmp\");\nheatmap_tmp[idx] = global.get(\"pointcloud\");\n\nglobal.set(\"heatmap_tmp\", heatmap_tmp);\nglobal.set(\"heatmap_idx\", idx);\n\n\n// ヒートマップデータの更新\nvar data = {};\nfor (var i=0;i<10;i++) {\n    for (var pos in heatmap_tmp[i]) {\n        if (pos in data) {\n            data[pos] += 1;\n        }\n        else {\n            data[pos] = 1;\n        }\n    }\n}\n\nglobal.set(\"heatmap\", data);\n\n\nreturn msg;","outputs":1,"noerr":0,"x":662,"y":327,"wires":[["fa44c0bc.d0c18"]]},{"id":"959d4d6.767d6b","type":"websocket-listener","z":"","path":"/ws/position","wholemsg":"false"},{"id":"4347228e.e8e62c","type":"websocket-listener","z":"","path":"/ws/pointcloud","wholemsg":"false"}]
```