# LOFSIL
WIP

GR-PEACHで動作するサンプルプログラムです。  

## ビルド手順
開発環境の構築は、[GR-LYCHEE用オフライン開発環境の手順](https://developer.mbed.org/users/dkato/notebook/offline-development-lychee-langja/)を参照ください。

### GR-PEACHの場合
$ mbed compile -m RZ_A1H -t GCC_ARM --profile debug

## 概要
USB0にUSBケーブルを接続してPC用アプリ [DisplayApp](https://developer.mbed.org/users/dkato/code/DisplayApp/)でカメラ映像が表示できます。

～参考ページ～  
[がじぇっとるねさすコミュニティ GR-LYCHEE OpenCV](http://japan.renesasrulz.com/gr_user_forum_japanese/f/gr-lychee/4208/gr-lychee-opencv)

## 実行方法
```
cd client && ruby -rwebrick -e 'WEBrick::HTTPServer.new(:DocumentRoot => "./", :Port => 8000).start'
```

## node-red
データを受信して位置情報、点群データ、3Dヒートマップに変換するためのnode-redフロー

```
[{"id":"5f004c04.5e3e84","type":"websocket out","z":"2885055e.4e0d6a","name":"","server":"f2b6a0f4.e21d2","client":"","x":709.8888549804688,"y":254.44442749023438,"wires":[]},{"id":"53339c83.df18d4","type":"inject","z":"2885055e.4e0d6a","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":true,"x":76.44444274902344,"y":95.22222137451172,"wires":[["702670f5.6fd2c"]]},{"id":"702670f5.6fd2c","type":"function","z":"2885055e.4e0d6a","name":"初期化","func":"global.set(\"pointcloud\", {});\nglobal.set(\"_pointcloud\", {});\n\nglobal.set(\"heatmap\", {});\nglobal.set(\"heatmap_tmp\", []);\nglobal.set(\"heatmap_idx\", 0);\n\nglobal.set(\"_position\", {x:0, y:0, z:0});\nglobal.set(\"count\", 0);\n\nreturn msg;","outputs":1,"noerr":0,"x":250.4444580078125,"y":95,"wires":[["2556c1e5.badeee"]]},{"id":"2556c1e5.badeee","type":"debug","z":"2885055e.4e0d6a","name":"","active":true,"console":"false","complete":"false","x":446,"y":95,"wires":[]},{"id":"f01fd466.ab4ab8","type":"function","z":"2885055e.4e0d6a","name":"位置情報の送信","func":"delete msg._session;\nreturn msg;","outputs":1,"noerr":0,"x":484,"y":254,"wires":[["dddeab09.920ac8","5f004c04.5e3e84"]]},{"id":"dddeab09.920ac8","type":"debug","z":"2885055e.4e0d6a","name":"","active":false,"console":"false","complete":"payload","x":700,"y":203,"wires":[]},{"id":"1fc13124.44fd2f","type":"websocket in","z":"2885055e.4e0d6a","name":"","server":"4892f0e6.33965","client":"","x":95,"y":258,"wires":[["9df988db.5a4058"]]},{"id":"9df988db.5a4058","type":"switch","z":"2885055e.4e0d6a","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"end","vt":"str"},{"t":"else"}],"checkall":"true","outputs":2,"x":205,"y":350,"wires":[["f0bf0993.6cfc98","5a12776a.334078"],["2c454481.aa6edc"]]},{"id":"542141fc.11a64","type":"function","z":"2885055e.4e0d6a","name":"点群データの更新","func":"// 点群データ\nvar data = global.get(\"_pointcloud\");\n\nif (msg.payload in data) {\n    data[msg.payload] += 1;\n} else {\n    data[msg.payload] = 1;\n}\n\nglobal.set(\"_pointcloud\", data);\n\nreturn msg;","outputs":1,"noerr":0,"x":423,"y":471,"wires":[[]]},{"id":"f0bf0993.6cfc98","type":"function","z":"2885055e.4e0d6a","name":"点群データの確定","func":"var pointcloud = global.get(\"_pointcloud\");\nglobal.set(\"pointcloud\", pointcloud);\nglobal.set(\"_pointcloud\", {});\n\nreturn msg;","outputs":1,"noerr":0,"x":420,"y":343,"wires":[["19b6be51.684ba2"]]},{"id":"13a0c106.76422f","type":"debug","z":"2885055e.4e0d6a","name":"","active":false,"console":"false","complete":"payload","x":687,"y":409,"wires":[]},{"id":"933ac317.cba2a","type":"http in","z":"2885055e.4e0d6a","name":"","url":"/pointcloud","method":"get","swaggerDoc":"","x":96,"y":545,"wires":[["3e3caa06.def5d6"]]},{"id":"d30ef5ac.a321c8","type":"http response","z":"2885055e.4e0d6a","name":"","x":524,"y":580,"wires":[]},{"id":"3e3caa06.def5d6","type":"function","z":"2885055e.4e0d6a","name":"点群データの取得","func":"msg.payload = global.get(\"pointcloud\");\nmsg.headers = {\"Access-Control-Allow-Origin\": \"*\"};\n\nreturn msg;\n","outputs":1,"noerr":0,"x":315,"y":555,"wires":[["d30ef5ac.a321c8"]]},{"id":"aff3bc70.88e9","type":"function","z":"2885055e.4e0d6a","name":"位置情報の更新","func":"var count = global.get(\"count\");\ncount++;\nglobal.set(\"count\", count);\n\nvar position = global.get(\"_position\");\nvar data = msg.payload.split(\" \");\n\nposition.x += parseInt(data[0]);\nposition.y += parseInt(data[1]);\nposition.z += parseInt(data[2]);\n\nglobal.set(\"_position\", position);\n\nreturn msg;","outputs":1,"noerr":0,"x":414,"y":424,"wires":[[]]},{"id":"5a12776a.334078","type":"function","z":"2885055e.4e0d6a","name":"位置情報の確定","func":"var count = global.get(\"count\");\nif (count === 0) return null;\n\nvar position = global.get(\"_position\");\nposition.x = Math.round(position.x / count);\nposition.y = Math.round(position.y / count);\nposition.z = Math.round(position.z / count);\n\nmsg.payload = position;\n\nglobal.set(\"_position\", {x:0, y:0, z:0});\nglobal.set(\"count\", 0);\n\nreturn msg;","outputs":1,"noerr":0,"x":410,"y":190,"wires":[["f01fd466.ab4ab8"]]},{"id":"2f90defe.a32522","type":"http in","z":"2885055e.4e0d6a","name":"","url":"/heatmap","method":"get","swaggerDoc":"","x":86,"y":623,"wires":[["e3b0642a.1d0f58"]]},{"id":"e697a018.2ce11","type":"http response","z":"2885055e.4e0d6a","name":"","x":517,"y":669,"wires":[]},{"id":"e3b0642a.1d0f58","type":"function","z":"2885055e.4e0d6a","name":"ヒートマップの取得","func":"msg.payload = global.get(\"heatmap\");\nmsg.headers = {\"Access-Control-Allow-Origin\": \"*\"};\n\nreturn msg;","outputs":1,"noerr":0,"x":311,"y":643,"wires":[["e697a018.2ce11"]]},{"id":"19b6be51.684ba2","type":"function","z":"2885055e.4e0d6a","name":"ヒートマップの確定","func":"var idx = global.get(\"heatmap_idx\");\nif (idx == 10) {\n    idx = 0;\n}\nelse {\n    idx++;\n}\n\nvar heatmap_tmp = global.get(\"heatmap_tmp\");\nheatmap_tmp[idx] = global.get(\"pointcloud\");\n\nglobal.set(\"heatmap_tmp\", heatmap_tmp);\nglobal.set(\"heatmap_idx\", idx);\n\n\n// ヒートマップデータの更新\nvar data = {};\n// for (var i=0;i<10;i++) {\n//     for (var pos in heatmap_tmp[i]) {\n//         if (pos in data) {\n//             data[pos] += 1;\n//         }\n//         else {\n//             data[pos] = 1;\n//         }\n//     }\n// }\n\nfor (var pos in heatmap_tmp[idx]) {\n    if (pos in data) {\n        data[pos] += 1;\n    }\n    else {\n        data[pos] = 1;\n    }\n}\n\n\nglobal.set(\"heatmap\", data);\n\n\nreturn msg;","outputs":1,"noerr":0,"x":626,"y":343,"wires":[["13a0c106.76422f"]]},{"id":"2c454481.aa6edc","type":"function","z":"2885055e.4e0d6a","name":"バイナリデータの変換","func":"var str = msg.payload;\nvar ret = \"\";\nret += str.charCodeAt(0);\nret += \" \";\nret += str.charCodeAt(1);\nret += \" \";\nret += str.charCodeAt(2);\nmsg.payload = ret;\n\nreturn msg;","outputs":1,"noerr":0,"x":195,"y":440,"wires":[["aff3bc70.88e9","542141fc.11a64"]]},{"id":"f2b6a0f4.e21d2","type":"websocket-listener","z":"","path":"/ws/position","wholemsg":"false"},{"id":"4892f0e6.33965","type":"websocket-listener","z":"","path":"/ws/pointcloud","wholemsg":"false"}]
```