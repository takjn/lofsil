<html>

<head>
    <title>A-Frame Point Component - Star map</title>
    <meta name="description" content="Using Point component for rendering very many points."></meta>
    <script src="./aframe.min.js"></script>
    <script src="./aframe-point-component.js"></script>
</head>

<body>
    <a-scene>
        <a-entity id='cameraWrapper' position="0 0 0">
            <a-camera>
            <a-entity id="myCursor" cursor="fuse:true;" scale="0.01 0.01 0.01" position="0 0 -0.5" geometry="primitive: ring" material="color: white; shader: flat; opacity:0.5">
            </a-entity>
          </a-camera>
        </a-entity>

        <a-sphere position="0 1.6 -5" radius="1.25" color="#EF2D5E"></a-sphere>
        <a-box position="-1 0.5 -3" rotation="0 45 0" width="1" height="1.5" depth="1"  color="#4CC3D9"></a-box>
        <a-cylinder position="1 0.75 -3" radius="0.5" height="2.0" color="#FFC65D"></a-cylinder>

        <a-plane position="0 0 0" rotation="-90 0 0" width="5" height="5" color="#7BC8A4"></a-plane>
        <!-- <a-plane position="-2 0.01 0" rotation="-90 0 0" width="2" height="2" color="#000000"></a-plane> -->
        <a-point position="0 0 0" size="0.20" perspective="true" opacity="0.9" transparent="true"></a-point>
        <a-sky color="#444499"></a-sky>

    </a-scene>
    <script>
        const points = document.querySelector("a-point")
        const mul = x => 0.10 * x

        var update_lock = false;

        function getData() {
            update_lock = true;

            var req = new XMLHttpRequest();
            req.open("get", "http://192.168.0.12:1880/heatmap", true);

            req.onload = function (e) {
                if (req.readyState === 4) {
                    if (req.status === 200) {

                        var pointcloud = [];

                        var data = JSON.parse(req.responseText);

                        var result = [];
                        for (key in data) {
                            var pos = key.split(" ");
                            pos.push(data[key]);
                            pointcloud.push(pos);
                        }

                        points.components.point.setPoints(
                            pointcloud
                                .map(star => [mul(30 - star[0]), mul(star[1]), mul(30 - star[2]), star[3]]));
                        
                        update_lock = false;

                    } else {
                        // console.error(xhr.statusText);
                        update_lock = false;
                    }
                }
            };
            req.onerror = function (e) {
                // console.error(xhr.statusText);
                update_lock = false;
            };

            req.send(null); // HTTPリクエストの発行

            return;
        }

        var ws = new WebSocket('ws://192.168.0.12:1880/ws/position');
		ws.onopen = function() {
			console.log('onopen');
		};
		ws.onmessage = function (event) {
            // console.log("onmessage");
			// var msg = JSON.parse(event.data);

			// var x = mul(30 - msg.x) * 1.75;
			// var y = 0;
            // var z = mul(30 - msg.z) * 1.75;
            
            // document.querySelector("#cameraWrapper").setAttribute('position', {x: x, y: y, z: z})
            
            if (!update_lock) {
                getData();
            }
        };


    </script>
</body>

</html>
