<html>

<head>
    <title>lofsil - 3D Heatmap</title>
    <script src="./js/aframe.min.js"></script>
    <script src="./js/aframe-point-component.js"></script>
</head>

<body>
    <a-scene>
        <a-assets>
            <img id="banner" src="./image/banner.jpg">
            <img id="contest" src="./image/contest.png">
            <img id="kyara" src="./image/kyara.png">
            <img id="gr-citrus" src="./image/gr-citrus.jpg">
            <img id="gr-cotton" src="./image/gr-cotton.jpg">
            <img id="gr-adzuki" src="./image/gr-adzuki.jpg">
            <img id="gr-kurumi" src="./image/gr-kurumi.jpg">
            <img id="gr-peach" src="./image/gr-peach.jpg">
            <img id="gr-sakura" src="./image/gr-sakura.jpg">
            <audio id="click-sound" crossorigin="anonymous" src="https://cdn.aframe.io/360-image-gallery-boilerplate/audio/click.ogg"></audio>            
        </a-assets>

        <a-entity id='cameraWrapper' position="0 0 0">
            <a-entity camera="userHeight: 1.3; fov:30;" look-controls wasd-controls="fly:true">
            </a-entity>
        </a-entity>

        <a-light type="directional" color="#FFF" intensity="0.45" position="4 2 1"></a-light>
        <a-light type="ambient" color="#A8A8A8"></a-light>

        <a-point position="0 0 0" size="0.30" perspective="true" opacity="0.9" transparent="true"></a-point>

        <a-plane position="0 0 0" rotation="-90 0 0" width="1.8" height="1.8" color="#249889"></a-plane>
        <a-plane position="0 -0.01 0" rotation="-90 0 0" width="2" height="2" color="#FFFF00"></a-plane>
        <a-plane position="0 -0.02 0" rotation="-90 0 0" width="4" height="4" color="#249889"></a-plane>
        <a-sky color="#24CAFF" radius="1000"></a-sky>
        
        <a-image src="#banner" width="4.5" height="3" position="0 1.5 -5" rotation="0 0 0"></a-image>
        <a-image src="#contest" width="4" height="0.3" position="0 1 4" rotation="0 -180 0"></a-image>
        <a-image src="#kyara" width="0.6" height="0.4" position="0 0.01 0" rotation="-90 0 0"></a-image>

        <a-entity id="1-1" scale="1.5 1 1">
            <a-image src="#gr-cotton" width="1.25" height="1" position="4 1 -1.8" rotation="0 -90 0"></a-image>
            <a-text font="kelsonsans" value="GR-COTTON" width="4" position="4 0.4 -1.8" rotation="0 -90 0" align="center"></a-text>
        </a-entity>

        <a-entity id="1-2" scale="1.5 1 1">
            <a-image src="#gr-citrus" width="1.3" height="1" position="4 1 0" rotation="0 -90 0"></a-image>
            <a-text font="kelsonsans" value="GR-CITRUS" width="4" position="4 0.4 0" rotation="0 -90 0" align="center"></a-text>
        </a-entity>

        <a-entity id="1-3" scale="1.5 1 1">
            <a-image src="#gr-kurumi" width="1.23" height="1" position="4 1 1.8" rotation="0 -90 0"></a-image>
            <a-text font="kelsonsans" value="GR-KURUMI" width="4" position="4 0.4 1.8" rotation="0 -90 0" align="center"></a-text>
        </a-entity>
    
        <a-entity id="2-1" scale="1.5 1 1">
            <a-image src="#gr-adzuki" width="1.18" height="1" position="-4 1 -1.8" rotation="0 90 0"></a-image>
            <a-text font="kelsonsans" value="GR-ADUKI" width="4" position="-4 0.4 -1.8" rotation="0 90 0" align="center"></a-text>
        </a-entity>
        <a-entity id="2-2" scale="1.5 1 1">
            <a-image src="#gr-peach" width="1.39" height="1" position="-4 1 0" rotation="0 90 0"></a-image>
            <a-text font="kelsonsans" value="GR-PEACH" width="4" position="-4 0.4 0" rotation="0 90 0" align="center"></a-text>
        </a-entity>
        <a-entity id="2-3" scale="1.5 1 1">
            <a-image src="#gr-sakura" width="1.3" height="1" position="-4 1 1.8" rotation="0 90 0"></a-image>
            <a-text font="kelsonsans" value="GR-SAKURA" width="4" position="-4 0.4 1.8" rotation="0 90 0" align="center"></a-text>
        </a-entity>

    </a-scene>
    <script>
        const url_base = "192.168.0.12:1880";   // node-red server address
        const pcd_offset = 25;                  // 3D grid size / 2
        const pcd_scale = x => 0.04 * x;        // resolution(mm/grid)

        const points = document.querySelector("a-point");
        var update_lock = false;

        function getData() {
            update_lock = true;

            var req = new XMLHttpRequest();
            req.open("get", "http://" + url_base + "/heatmap", true);

            req.onload = function (e) {
                if (req.readyState === 4) {
                    if (req.status === 200) {

                        var pointcloud = [];

                        var data = JSON.parse(req.responseText);

                        var result = [];
                        for (key in data) {
                            var pos = key.split(" ");
                            pos.push(data[key]);
                            pointcloud.push(pos);
                        }


                        points.components.point.setPoints(
                            pointcloud
                                .map(star => [pcd_scale(pcd_offset - star[0]), pcd_scale(star[1]), pcd_scale(pcd_offset - star[2]), star[3]]));
                        
                        update_lock = false;

                    } else {
                        // console.error(xhr.statusText);
                        update_lock = false;
                    }
                }
            };
            req.onerror = function (e) {
                // console.error(xhr.statusText);
                update_lock = false;
            };

            req.send(null); // HTTPリクエストの発行

            return;
        }

        var ws = new WebSocket('ws://' + url_base + '/ws/position');
		ws.onopen = function() {
			console.log('onopen');
		};
		ws.onmessage = function (event) {
            // console.log("onmessage");
			// var msg = JSON.parse(event.data);

			// var x = pcd_scale(pcd_offset - msg.x);
			// var y = 0;
            // var z = pcd_scale(pcd_offset - msg.z);
            
            // document.querySelector("#cameraWrapper").setAttribute('position', {x: x, y: y, z: z})
            
            if (!update_lock) {
                getData();
            }
        };


    </script>
</body>

</html>
